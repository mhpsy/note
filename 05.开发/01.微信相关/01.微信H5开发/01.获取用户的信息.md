## 详细步骤和说明

### 网页授权的理论步骤

网页授权流程分为四步：

1.  引导用户进入授权页面同意授权，获取code
2.  通过code换取网页授权access_token（与基础支持中的access_token不同）
3.  如果需要，开发者可以刷新网页授权access_token，避免过期
4.  通过网页授权access_token和openid获取用户基本信息（支持UnionID机制）

### 我做的步骤

#### 1.设置好回调域名

[[设置网页授权回调域名#设置网页授权回调域名]]

#### 2.拼凑出来调用的一个url

“引导”用户打开如下网页
`https://open.weixin.qq.com/connect/oauth2/authorize?appid=APPID&redirect_uri=REDIRECT_URI&response_type=code&scope=SCOPE&state=STATE#wechat_redirect`

可以看到几个参数：

- **appid**: 公众号的唯一标识
- **redirect_uri**: 授权后重定向的回调链接地址， 请使用 urlEncode 对链接进行处理
- **response_type**: 返回类型，请填写code
- **scope**: 可选 snsapi_base 和 snsapi_userinfo [[两种scope的区别]]
- **state**: 重定向后会带上state参数，开发者可以填写a-zA-Z0-9的参数值，最多128字节
- `#wechat_redirec`:无论直接打开还是做页面302重定向时候，必须带此参数

#### 3.在微信的h5里面跳转到上面拼凑出来的网页上
```
window.location.href =  
    `https://open.weixin.qq.com/connect/oauth2/authorize?appid=${appid}&redirect_uri=${redirect_uri}&response_type=${response_type}&scope=${scope}&state=${state}#wechat_redirect`;
```

直接改变window.location.href就好了

如果顺利的话 微信会跳转回去指定的`redirect_uri`然后后面会带上code和state，state是自己指定的，code是腾讯返回的。

#### 4.通过code获取token和openid
需要先配置secret和白名单IP，接下来就能用配置的白名单的ip去通过code去请求openid和token了

##### java的service代码如下
```java
@Service  
public class WeiXinVerifyServiceImpl implements WeiXinVerifyService {  
    private static final String app_id = "xxx";//微信公众号的appid  
    private static final String app_secret = "xxx";//微信公众号的secret  
    private static final String grant_type = "authorization_code";//授权类型，此处只需填写authorization_code  
    private static final String BaseUrl = "https://api.weixin.qq.com/sns/oauth2/access_token?appid=";  
  
    @Override  
    public String getOpenId(String code) throws IOException {  
  
        String path = BaseUrl + app_id + "&secret=" + app_secret + "&code=" + code + "&grant_type=" + grant_type;  
  
        URL url = new URL(path);  
        HttpURLConnection con = (HttpURLConnection) url.openConnection();  
        con.setRequestMethod("GET");  
  
        int responseCode = con.getResponseCode();  
  
        BufferedReader in = new BufferedReader(  
                new InputStreamReader(con.getInputStream()));  
        String inputLine;  
        StringBuilder response = new StringBuilder();  
        while ((inputLine = in.readLine()) != null) {  
            response.append(inputLine);  
        }  
        in.close();  
  
        System.out.println(response.toString());  
  
        return null;    
        }  
}
```





##### 实际操作
这时候就有了openid和token了 可以传给前端保存到用户的手机上面 其实挺扯的我现在做的项目是完全用openid作为唯一鉴权的。很扯真的很扯。但是没办法项目经理认为这样好，可以让用户省事。



